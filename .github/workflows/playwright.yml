name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    # Checkout the current repository code
    - uses: actions/checkout@v4

    # Checkout the gh-pages branch to retrieve the previous Allure report history
    - name: Checkout gh-pages (retrieve Allure history)
      uses: actions/checkout@v4
      with:
        ref: gh-pages          # branch where the last report is stored
        path: old-report        # directory where it will be downloaded
      continue-on-error: true   # avoid breaking the workflow if this branch does not exist yet

    # Restore Allure history from the previous report
    - name: Restore Allure history
      run: |
        mkdir -p allure-results/history
        if [ -d "old-report/history" ]; then
          echo "✔ Previous Allure history found. Restoring..."
          cp -r old-report/history allure-results/
        else
          echo "ℹ No history found in gh-pages."
        fi

    # Setup Node.js
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    # Install Node dependencies
    - name: Install dependencies
      run: npm ci

    # Install Playwright browsers and dependencies
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    # Execute Playwright tests
    - name: Run Playwright tests
      run: npx playwright test

    # Generate the Allure Report (with restored history)
    - name: Generate Allure Report
      run: npx allure generate allure-results --clean -o allure-report

    # Deploy the generated Allure Report to GitHub Pages
    - name: Deploy Allure Report to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: ${{ !cancelled() }}
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages   # GitHub Pages publishing branch
        publish_dir: allure-report # Directory containing the report to publish

    # Upload Allure report as CI artifact (optional)
    - name: Upload Allure Report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: allure-report
        path: allure-report/
        retention-days: 30
